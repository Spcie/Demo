#include "nokia5110.h"
/******************************************************************************************
NOKIA5110 驱动  使用软件模拟SPI通信 
占用资源 ：PG2-DC PG4-CE PG6-RET PG8-DIN PG7-CLK 
BL为背光电源，可选择关闭
划线函数 Nokia_Line 只能画垂直或水平的线

******************************************************************************************/
/*************************************字库************************************************/
const unsigned char font6x8[92][6] =
{
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },   
    { 0x00, 0x00, 0x00, 0x2f, 0x00, 0x00 },   
    { 0x00, 0x00, 0x07, 0x00, 0x07, 0x00 },   
    { 0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14 },   
    { 0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12 },   
    { 0x00, 0x62, 0x64, 0x08, 0x13, 0x23 },   
    { 0x00, 0x36, 0x49, 0x55, 0x22, 0x50 },   
    { 0x00, 0x00, 0x05, 0x03, 0x00, 0x00 },   
    { 0x00, 0x00, 0x1c, 0x22, 0x41, 0x00 },   
    { 0x00, 0x00, 0x41, 0x22, 0x1c, 0x00 },   
    { 0x00, 0x14, 0x08, 0x3E, 0x08, 0x14 },   
    { 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08 },   
    { 0x00, 0x00, 0x00, 0xA0, 0x60, 0x00 },   
    { 0x00, 0x08, 0x08, 0x08, 0x08, 0x08 },   
    { 0x00, 0x00, 0x60, 0x60, 0x00, 0x00 },   
    { 0x00, 0x20, 0x10, 0x08, 0x04, 0x02 },   
    { 0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E },   
    { 0x00, 0x00, 0x42, 0x7F, 0x40, 0x00 },   
    { 0x00, 0x42, 0x61, 0x51, 0x49, 0x46 },   
    { 0x00, 0x21, 0x41, 0x45, 0x4B, 0x31 },   
    { 0x00, 0x18, 0x14, 0x12, 0x7F, 0x10 },   
    { 0x00, 0x27, 0x45, 0x45, 0x45, 0x39 },   
    { 0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30 },   
    { 0x00, 0x01, 0x71, 0x09, 0x05, 0x03 },   
    { 0x00, 0x36, 0x49, 0x49, 0x49, 0x36 },   
    { 0x00, 0x06, 0x49, 0x49, 0x29, 0x1E },   
    { 0x00, 0x00, 0x36, 0x36, 0x00, 0x00 },   
    { 0x00, 0x00, 0x56, 0x36, 0x00, 0x00 },  
    { 0x00, 0x08, 0x14, 0x22, 0x41, 0x00 },   
    { 0x00, 0x14, 0x14, 0x14, 0x14, 0x14 },   
    { 0x00, 0x00, 0x41, 0x22, 0x14, 0x08 },   
    { 0x00, 0x02, 0x01, 0x51, 0x09, 0x06 },   
    { 0x00, 0x32, 0x49, 0x59, 0x51, 0x3E },   
    { 0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C },   
    { 0x00, 0x7F, 0x49, 0x49, 0x49, 0x36 },   
    { 0x00, 0x3E, 0x41, 0x41, 0x41, 0x22 },   
    { 0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C },   
    { 0x00, 0x7F, 0x49, 0x49, 0x49, 0x41 },  
    { 0x00, 0x7F, 0x09, 0x09, 0x09, 0x01 },   
    { 0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A },   
    { 0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F },   
    { 0x00, 0x00, 0x41, 0x7F, 0x41, 0x00 },   
    { 0x00, 0x20, 0x40, 0x41, 0x3F, 0x01 },   
    { 0x00, 0x7F, 0x08, 0x14, 0x22, 0x41 },   
    { 0x00, 0x7F, 0x40, 0x40, 0x40, 0x40 },   
    { 0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F },   
    { 0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F },   
    { 0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E },   
    { 0x00, 0x7F, 0x09, 0x09, 0x09, 0x06 },   
    { 0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E },   
    { 0x00, 0x7F, 0x09, 0x19, 0x29, 0x46 },   
    { 0x00, 0x46, 0x49, 0x49, 0x49, 0x31 },   
    { 0x00, 0x01, 0x01, 0x7F, 0x01, 0x01 },   
    { 0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F },   
    { 0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F },   
    { 0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F },   
    { 0x00, 0x63, 0x14, 0x08, 0x14, 0x63 },   
    { 0x00, 0x07, 0x08, 0x70, 0x08, 0x07 },   
    { 0x00, 0x61, 0x51, 0x49, 0x45, 0x43 },   
    { 0x00, 0x00, 0x7F, 0x41, 0x41, 0x00 },   
    { 0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55 },   
    { 0x00, 0x00, 0x41, 0x41, 0x7F, 0x00 },   
    { 0x00, 0x04, 0x02, 0x01, 0x02, 0x04 },   
    { 0x00, 0x40, 0x40, 0x40, 0x40, 0x40 },   
    { 0x00, 0x00, 0x01, 0x02, 0x04, 0x00 },   
    { 0x00, 0x20, 0x54, 0x54, 0x54, 0x78 },  
    { 0x00, 0x7F, 0x48, 0x44, 0x44, 0x38 },  
    { 0x00, 0x38, 0x44, 0x44, 0x44, 0x20 },   
    { 0x00, 0x38, 0x44, 0x44, 0x48, 0x7F },   
    { 0x00, 0x38, 0x54, 0x54, 0x54, 0x18 },   
    { 0x00, 0x08, 0x7E, 0x09, 0x01, 0x02 },  
    { 0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C },   
    { 0x00, 0x7F, 0x08, 0x04, 0x04, 0x78 },   
    { 0x00, 0x00, 0x44, 0x7D, 0x40, 0x00 },   
    { 0x00, 0x40, 0x80, 0x84, 0x7D, 0x00 },  
    { 0x00, 0x7F, 0x10, 0x28, 0x44, 0x00 },   
    { 0x00, 0x00, 0x41, 0x7F, 0x40, 0x00 },   
    { 0x00, 0x7C, 0x04, 0x18, 0x04, 0x78 },   
    { 0x00, 0x7C, 0x08, 0x04, 0x04, 0x78 },   
    { 0x00, 0x38, 0x44, 0x44, 0x44, 0x38 },   
    { 0x00, 0xFC, 0x24, 0x24, 0x24, 0x18 },   
    { 0x00, 0x18, 0x24, 0x24, 0x18, 0xFC },   
    { 0x00, 0x7C, 0x08, 0x04, 0x04, 0x08 },   
    { 0x00, 0x48, 0x54, 0x54, 0x54, 0x20 },   
    { 0x00, 0x04, 0x3F, 0x44, 0x40, 0x20 },  
    { 0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C },  
    { 0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C },   
    { 0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C },   
    { 0x00, 0x44, 0x28, 0x10, 0x28, 0x44 },  
    { 0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C },   
    { 0x00, 0x44, 0x64, 0x54, 0x4C, 0x44 },   
    { 0x14, 0x14, 0x14, 0x14, 0x14, 0x14 },
	};   

/******************************************************************************************
函数名：Nokia_Init
功能： Nokia5110连接IO口配置   Nokia5110设置
输入：无
输出：0
******************************************************************************************/
int Nokia_Init(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
	
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2 |GPIO_Pin_4 | GPIO_Pin_6 |GPIO_Pin_7 | GPIO_Pin_8;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOG,&GPIO_InitStructure);
	
	Nokia5110_RET_0;
	delay_us(1);
	Nokia5110_RET_1;                                         //产生一个使LCD复位的低脉冲                            
	 
	Nokia5110_CE_0;                                          //取消片选
	delay_us(1);
	Nokia5110_CE_1;                                          //使能片选
	delay_us(1);
	Nokia_write_byte(0x21,0);                                //使用扩展设置LCD模式
	Nokia_write_byte(0xc8,0);                                //设置液晶偏置电压
	Nokia_write_byte(0x06,0);                                //温度校正
	Nokia_write_byte(0x13,0);                                //1：48
	Nokia_write_byte(0x20,0);                                //使用基本命令 V=0 水平寻址
	Nokia_clear();                                           //清屏
	Nokia_write_byte(0x0c,0);                                //设置显示模式，正常显示
	
	Nokia5110_CE_0;                                          //取消片选
	
	return 0;
}
/******************************************************************************************
函数名：nokia_write_byte
功能：向nokia5110写一个字节
输入：dat: 发送的字节 mode：0 写命令  1写数据
输出：0
******************************************************************************************/
int Nokia_write_byte(unsigned char dat,unsigned char mode)
{
	int i;
	Nokia5110_CE_0;                                          //片选有效
	if(mode == 0) Nokia5110_DC_0;                            //写命令
	if(mode == 1) Nokia5110_DC_1;                            //写数据
	  for(i=0;i<8;i++)				  //发送8字节
  {
    if(dat&0x80)
      Nokia5110_DIN_1;
    else
      Nokia5110_DIN_0;
		
    Nokia5110_CK_0;
    dat = dat << 1;
    Nokia5110_CK_1;                //一个时钟脉冲
  }
	//SPI2_ReadWriteByte(dat);                                 //发送数据
	Nokia5110_CE_1;                                          //取消片选
	return 0;
}
/******************************************************************************************
函数名：Nokia_clear
功能： Nokia5110清屏
输入：无
输出：0
******************************************************************************************/
int Nokia_clear(void)
{
	unsigned int i;
	Nokia_write_byte(0x0C,0);
	Nokia_write_byte(0x80,0);
	for(i=0;i<504;i++)
	{
		Nokia_write_byte(0,1);
	}
	return 0;
}
/******************************************************************************************
函数名：Nokia_SetCoordiate
功能：屏幕坐标与GRAM地址转换
输入：Ｘ：ｘ坐标　Ｙ：ｙ坐标
输出：0
******************************************************************************************/
int Nokia_SetCoordiate(unsigned char X,unsigned char Y)
{
	Nokia_write_byte(0x40|Y,0);
	Nokia_write_byte(0x80|X,0);
	return 0;
}
/******************************************************************************************
函数名： Nokia_Write_Char
功能 ：显示一个字符
输入 ：  显示的字符
输出 ：0
******************************************************************************************/
int Nokia_Write_Char(unsigned char c)
{
	unsigned char line;
	c-=32;
	for(line=0;line<6;line++)
	{
		Nokia_write_byte(font6x8[c][line],1);
	}
	return 0;
}
/******************************************************************************************
函数名：Nokia_WriteEnglishString
功能 ：在指定坐标起始处显示一个字符串
输入：X ：横坐标，Y：纵坐标 *s ：字符串指针
******************************************************************************************/
int Nokia_WriteEnglishString(unsigned char X,unsigned char Y,char *s)
{
	Nokia_SetCoordiate(X,Y);
	while(*s)
	{
		Nokia_Write_Char(*s);
		s++;
	}
	return 0;
}
/******************************************************************************************
函数名：Nokia_DrawPiont
功能： 画点函数
输入：点坐标
输出： 无
******************************************************************************************/
int Nokia_DrawPiont(unsigned char X,unsigned Y)
{
	Nokia_SetCoordiate(X,Y);
	Nokia_write_byte(BIT(Y % 8),1);
	return 0;
}
/******************************************************************************************
函数名：Nokia_Line
功能：画线函数
输入：StartX StartY  起始点坐标         EndX EndY终点坐标

******************************************************************************************/

void Nokia_Line(unsigned char StartX, unsigned char StartY, unsigned char EndX, unsigned char EndY)
{
  unsigned char TempX,TempY;
  unsigned char TempByte=0xFF;
  if(EndY<StartY)                                                        //变换划线方向，所有方向都是Y增加
  {
    TempX=StartX;
	StartX=EndX;
	EndX=TempX;
	TempY=StartY;
	StartY=EndY;
	EndY=TempY;
  }
  
  if(EndX==StartX)                                                       //进过变化后，x相等就改为竖直向下画线
  {
    //首先为前端处理
    if(StartY%8)                                                         //不能被8整除说明有跨字节
	{
	  Nokia_SetCoordiate(StartX,StartY/8);
	  //判断长度是否够
	  if((EndY-StartY)>(7-StartY%8))                                       //说明长度够了
	  {
	    TempByte>>=(StartY%8);
		TempByte<<=(StartY%8);
		Nokia_write_byte(TempByte,1);
		StartY+=(7-StartY%8);                                                //补足StartY进入下个环节
	  }
	  else                                                                 //长度不够一个字节
	  {
	    TempByte>>=(StartY%8);
		TempByte<<=(StartY%8+7-EndY%8);
		TempByte>>=(7-EndY%8);
		Nokia_write_byte(TempByte,1);
		return;
	  }
	}
	//这里的操作坐标起始坐标都没有跨越字节(不够的已经处理完毕，不够的补到下一个字节)
	//中段处理
	while(EndY-StartY>7)
	{
	 Nokia_SetCoordiate(StartX,StartY/8);
	  Nokia_write_byte(0xFF,1);
	  StartY+=8;                     //坐标递增
	}
	//末端处理
	TempByte=0xFF;
	TempByte<<=(7-EndY%8);
	TempByte>>=(7-EndY%8);
	Nokia_SetCoordiate(StartX,StartY/8);
	Nokia_write_byte(TempByte,1);
  }
  else if(StartY==EndY) //现在是斜率为0的情况
  {
    if(StartX>EndX)
	{
	  TempX=StartX;
	  StartX=EndX;
	  EndX=TempX;
	}
	Nokia_SetCoordiate(StartX,StartY/8);
	while(EndX+1-StartX)
	{
	  Nokia_write_byte(BIT(StartY%8),1);
	  StartX++;
	}
  }

}



/***************************************结束**********************************************/



